<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å•†å®¶ç®¡ç†ç«¯</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #f5f5f5;
        }
        .header {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
            color: white;
            padding: 20px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .header h1 {
            font-size: 28px;
            margin-bottom: 5px;
        }
        .tabs {
            display: flex;
            background: white;
            padding: 12px 16px;
            gap: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .tab {
            flex: 1;
            padding: 10px;
            background: #f5f5f5;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            color: #576b95;
            transition: all 0.3s;
        }
        .tab.active {
            background: #ff6b6b;
            color: white;
            font-weight: 600;
        }
        .tab:hover:not(.active) {
            background: #e8e8e8;
        }
        .stats {
            display: flex;
            gap: 15px;
            padding: 20px;
            background: white;
            margin: 15px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        .stat-card {
            flex: 1;
            text-align: center;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 10px;
            color: white;
        }
        .stat-value {
            font-size: 32px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .stat-label {
            font-size: 14px;
            opacity: 0.9;
        }
        .container {
            padding: 0 15px 20px;
        }
        .filter-bar {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            overflow-x: auto;
            padding: 5px 0;
        }
        .filter-btn {
            padding: 10px 20px;
            border: 2px solid #ff6b6b;
            background: white;
            color: #ff6b6b;
            border-radius: 20px;
            cursor: pointer;
            white-space: nowrap;
            font-weight: 500;
            transition: all 0.3s;
        }
        .filter-btn.active {
            background: #ff6b6b;
            color: white;
        }
        .order-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            border-left: 4px solid #ff6b6b;
            animation: slideIn 0.3s ease;
        }
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .order-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px dashed #eee;
        }
        .order-number {
            font-size: 16px;
            font-weight: bold;
            color: #333;
        }
        .order-time {
            font-size: 13px;
            color: #999;
        }
        .order-status {
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: bold;
        }
        .status-pending {
            background: #fff3cd;
            color: #856404;
        }
        .status-accepted {
            background: #d1ecf1;
            color: #0c5460;
        }
        .status-preparing {
            background: #d4edda;
            color: #155724;
        }
        .status-completed {
            background: #e2e3e5;
            color: #383d41;
        }
        .status-cancelled {
            background: #f8d7da;
            color: #721c24;
        }
        .order-items {
            margin: 15px 0;
        }
        .order-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            color: #555;
        }
        .item-name {
            font-weight: 500;
        }
        .item-quantity {
            color: #ff6b6b;
            font-weight: bold;
        }
        .order-note {
            background: #fffbea;
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            font-size: 14px;
            color: #666;
            border-left: 3px solid #ffc107;
        }
        .order-total {
            font-size: 20px;
            font-weight: bold;
            color: #ff6b6b;
            text-align: right;
            margin: 10px 0;
        }
        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        .action-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            font-size: 14px;
            transition: all 0.3s;
        }
        .btn-confirm {
            background: #4CAF50;
            color: white;
        }
        .btn-prepare {
            background: #2196F3;
            color: white;
        }
        .btn-ready {
            background: #FF9800;
            color: white;
        }
        .btn-complete {
            background: #9E9E9E;
            color: white;
        }
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }
        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 15px;
        }
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #4CAF50;
            color: white;
            padding: 15px 25px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            display: none;
            z-index: 1000;
            animation: slideInRight 0.3s ease;
        }
        @keyframes slideInRight {
            from {
                transform: translateX(100%);
            }
            to {
                transform: translateX(0);
            }
        }
        .notification.show {
            display: block;
        }
        .connection-status {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: bold;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .status-connected {
            background: #4CAF50;
            color: white;
        }
        .status-disconnected {
            background: #f44336;
            color: white;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸª é¦™é¦™å¨æˆ¿ï¼ˆå•†å®¶ç«¯ï¼‰</h1>
        <p>ç”¨äºç®¡ç†èœå•ã€æ¥æ”¶ç‚¹å•ï¼Œè®©æ¯ä¸€é¡¿é¥­éƒ½æŒ‰å¿ƒæ„å®Œæˆ</p>
    </div>

    <div class="tabs">
        <button class="tab" onclick="location.href='demo.html'">ğŸ‘¤ ç‚¹é¤</button>
        <button class="tab active">ğŸª å•†å®¶ç«¯</button>
    </div>

    <div style="padding: 15px; background: white; margin: 15px; border-radius: 12px; display: flex; gap: 10px;">
        <button onclick="showAddDishModal()" style="flex: 1; padding: 12px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 15px; font-weight: bold;">â• æ·»åŠ æ–°èœå“</button>
        <button onclick="viewDishes()" style="flex: 1; padding: 12px; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 15px; font-weight: bold;">ğŸ“‹ æŸ¥çœ‹èœå“åˆ—è¡¨</button>
    </div>

    <div class="stats">
        <div class="stat-card">
            <div class="stat-value" id="totalOrders">0</div>
            <div class="stat-label">æ€»è®¢å•</div>
        </div>
        <div class="stat-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
            <div class="stat-value" id="pendingOrders">0</div>
            <div class="stat-label">å¾…å¤„ç†</div>
        </div>
        <div class="stat-card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
            <div class="stat-value" id="totalRevenue">Â¥0</div>
            <div class="stat-label">æ€»æ”¶å…¥</div>
        </div>
    </div>

    <div class="container">
        <div class="filter-bar">
            <button class="filter-btn active" onclick="filterOrders('all')">å…¨éƒ¨è®¢å•</button>
            <button class="filter-btn" onclick="filterOrders('pending')">å¾…æ¥å•</button>
            <button class="filter-btn" onclick="filterOrders('accepted')">å·²æ¥å•</button>
            <button class="filter-btn" onclick="filterOrders('preparing')">åˆ¶ä½œä¸­</button>
            <button class="filter-btn" onclick="filterOrders('completed')">å·²å®Œæˆ</button>
            <button class="filter-btn" onclick="filterOrders('cancelled')">å·²å–æ¶ˆ</button>
        </div>

        <div id="ordersList"></div>
    </div>

    <div class="notification" id="notification">
        ğŸ”” æ–°è®¢å•åˆ°è¾¾ï¼
    </div>

    <!-- æ·»åŠ èœå“æ¨¡æ€æ¡† -->
    <div class="modal" id="addDishModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 3000; align-items: center; justify-content: center;">
        <div style="background: white; border-radius: 15px; width: 90%; max-width: 600px; max-height: 85vh; overflow-y: auto;">
            <div style="padding: 20px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center;">
                <h2 style="margin: 0;">â• æ·»åŠ æ–°èœå“</h2>
                <span onclick="closeAddDishModal()" style="font-size: 28px; cursor: pointer; color: #999;">&times;</span>
            </div>
            <div style="padding: 20px;">
                <form id="addDishForm" onsubmit="submitNewDish(event)">
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">èœå“åç§° *</label>
                        <input type="text" id="dishName" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px;">
                    </div>
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">ä»·æ ¼ï¼ˆå…ƒï¼‰*</label>
                        <input type="number" id="dishPrice" step="0.01" min="0" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px;">
                    </div>
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">èœå“æè¿° *</label>
                        <textarea id="dishDescription" required rows="3" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px; resize: vertical;"></textarea>
                    </div>
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">åˆ¶ä½œè¯´æ˜ï¼ˆå¯é€‰ï¼‰</label>
                        <textarea id="dishInstructions" rows="5" placeholder="é£Ÿæï¼š&#10;è°ƒæ–™ï¼š&#10;æ­¥éª¤ï¼š" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px; resize: vertical;"></textarea>
                    </div>
                    <div style="margin-bottom: 20px;">
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="checkbox" id="dishAvailable" checked style="margin-right: 8px; width: 18px; height: 18px;">
                            <span style="font-weight: bold;">ä¸Šæ¶é”€å”®</span>
                        </label>
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button type="submit" style="flex: 1; padding: 14px; background: #4CAF50; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer;">âœ… ç¡®è®¤æ·»åŠ </button>
                        <button type="button" onclick="closeAddDishModal()" style="flex: 1; padding: 14px; background: #999; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer;">å–æ¶ˆ</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- ç¼–è¾‘èœå“æ¨¡æ€æ¡† -->
    <div class="modal" id="editDishModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 3000; align-items: center; justify-content: center;">
        <div style="background: white; border-radius: 15px; width: 90%; max-width: 600px; max-height: 85vh; overflow-y: auto;">
            <div style="padding: 20px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center;">
                <h2 style="margin: 0;">âœï¸ ç¼–è¾‘èœå“</h2>
                <span onclick="closeEditDishModal()" style="font-size: 28px; cursor: pointer; color: #999;">&times;</span>
            </div>
            <div style="padding: 20px;">
                <form id="editDishForm" onsubmit="submitEditDish(event)">
                    <input type="hidden" id="editDishId">
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">èœå“åç§° *</label>
                        <input type="text" id="editDishName" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px;">
                    </div>
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">ä»·æ ¼ï¼ˆå…ƒï¼‰*</label>
                        <input type="number" id="editDishPrice" step="0.01" min="0" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px;">
                    </div>
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">èœå“æè¿° *</label>
                        <textarea id="editDishDescription" required rows="3" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px; resize: vertical;"></textarea>
                    </div>
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">åˆ¶ä½œè¯´æ˜ï¼ˆå¯é€‰ï¼‰</label>
                        <textarea id="editDishInstructions" rows="5" placeholder="é£Ÿæï¼š&#10;è°ƒæ–™ï¼š&#10;æ­¥éª¤ï¼š" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px; resize: vertical;"></textarea>
                    </div>
                    <div style="margin-bottom: 20px;">
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="checkbox" id="editDishAvailable" style="margin-right: 8px; width: 18px; height: 18px;">
                            <span style="font-weight: bold;">ä¸Šæ¶é”€å”®</span>
                        </label>
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button type="submit" style="flex: 1; padding: 14px; background: #667eea; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer;">âœ… ä¿å­˜ä¿®æ”¹</button>
                        <button type="button" onclick="closeEditDishModal()" style="flex: 1; padding: 14px; background: #999; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer;">å–æ¶ˆ</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- èœå“åˆ—è¡¨æ¨¡æ€æ¡† -->
    <div class="modal" id="dishListModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 3000; align-items: center; justify-content: center;">
        <div style="background: white; border-radius: 15px; width: 90%; max-width: 800px; max-height: 85vh; overflow-y: auto;">
            <div style="padding: 20px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center;">
                <h2 style="margin: 0;">ğŸ“‹ èœå“åˆ—è¡¨</h2>
                <span onclick="closeDishListModal()" style="font-size: 28px; cursor: pointer; color: #999;">&times;</span>
            </div>
            <div id="dishListContent" style="padding: 20px;"></div>
        </div>
    </div>

    <!-- è®¢å•è¯¦æƒ…æ¨¡æ€æ¡† -->
    <div class="modal" id="orderDetailModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 3000; align-items: center; justify-content: center;">
        <div style="background: white; border-radius: 15px; width: 90%; max-width: 700px; max-height: 85vh; overflow-y: auto;">
            <div style="padding: 20px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center;">
                <h2 style="margin: 0;">ğŸ“‹ è®¢å•è¯¦æƒ…</h2>
                <span onclick="closeOrderDetailModal()" style="font-size: 28px; cursor: pointer; color: #999;">&times;</span>
            </div>
            <div id="orderDetailContent" style="padding: 20px;"></div>
        </div>
    </div>

    <div class="connection-status status-disconnected" id="connectionStatus">
        ğŸ”´ æœªè¿æ¥
    </div>

    <script>
        const API_BASE = 'http://72.11.140.254:8000';
        const WS_URL = 'ws://72.11.140.254:8000/ws/merchant';
        let orders = [];
        let currentFilter = 'all';
        let ws = null;

        // åŠ è½½è®¢å•
        async function loadOrders() {
            try {
                const response = await fetch(`${API_BASE}/api/merchant/orders`);
                orders = await response.json();
                updateStats();
                displayOrders();
            } catch (error) {
                console.error('åŠ è½½è®¢å•å¤±è´¥:', error);
            }
        }

        // æ›´æ–°ç»Ÿè®¡æ•°æ®
        function updateStats() {
            document.getElementById('totalOrders').textContent = orders.length;
            const pending = orders.filter(o => o.status === 'pending').length;
            document.getElementById('pendingOrders').textContent = pending;
            const completedOrders = orders.filter(o => o.status === 'completed');
            const revenue = completedOrders.reduce((sum, o) => sum + o.total_amount, 0);
            document.getElementById('totalRevenue').textContent = `Â¥${revenue.toFixed(2)}`;
        }

        // æ˜¾ç¤ºè®¢å•
        function displayOrders() {
            const container = document.getElementById('ordersList');
            let filtered = currentFilter === 'all' 
                ? orders 
                : orders.filter(o => o.status === currentFilter);

            if (filtered.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">ğŸ“­</div>
                        <div>æš‚æ— è®¢å•</div>
                    </div>
                `;
                return;
            }

            container.innerHTML = filtered.map(order => {
                const statusClass = `status-${order.status}`;
                const statusText = {
                    'pending': 'å¾…æ¥å•',
                    'accepted': 'å·²æ¥å•',
                    'preparing': 'åˆ¶ä½œä¸­',
                    'completed': 'å·²å®Œæˆ',
                    'cancelled': 'å·²å–æ¶ˆ'
                }[order.status] || order.status;

                let buttons = '';
                if (order.status === 'pending') {
                    buttons = `
                        <button class="action-btn btn-confirm" onclick="acceptOrder('${order.id}')">âœ… æ¥å•</button>
                        <button class="action-btn" style="background: #999;" onclick="cancelOrder('${order.id}')">âŒ æ‹’ç»</button>
                    `;
                } else if (order.status === 'accepted') {
                    buttons = `
                        <button class="action-btn btn-prepare" onclick="startPreparing('${order.id}')">ğŸ‘¨â€ğŸ³ å¼€å§‹åˆ¶ä½œ</button>
                        <button class="action-btn" style="background: #2196F3; color: white;" onclick="viewOrderDetail('${order.id}')">ğŸ“‹ æŸ¥çœ‹è¯¦æƒ…</button>
                    `;
                } else if (order.status === 'preparing') {
                    buttons = `
                        <button class="action-btn btn-ready" onclick="completeOrder('${order.id}')">âœ”ï¸ å®Œæˆ</button>
                        <button class="action-btn" style="background: #2196F3; color: white;" onclick="viewOrderDetail('${order.id}')">ğŸ“‹ æŸ¥çœ‹è¯¦æƒ…</button>
                    `;
                }

                const itemsHtml = order.items.map(item => `
                    <div class="order-item">
                        <span class="item-name">${item.dish_name}</span>
                        <span class="item-quantity">x${item.quantity} @ Â¥${item.price}</span>
                    </div>
                `).join('');

                const noteHtml = order.note 
                    ? `<div class="order-note">ğŸ“ å¤‡æ³¨: ${order.note}</div>` 
                    : '';

                return `
                    <div class="order-card">
                        <div class="order-header">
                            <div>
                                <div class="order-number">è®¢å•å·: ${order.id}</div>
                                <div class="order-time">é¡¾å®¢: ${order.user_name} | ${new Date(order.created_at).toLocaleString('zh-CN')}</div>
                            </div>
                            <div class="order-status ${statusClass}">${statusText}</div>
                        </div>
                        <div class="order-items">
                            ${itemsHtml}
                        </div>
                        ${noteHtml}
                        <div class="order-total">åˆè®¡: Â¥${order.total_amount.toFixed(2)}</div>
                        <div class="action-buttons">
                            ${buttons}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // è¿‡æ»¤è®¢å•
        function filterOrders(status) {
            currentFilter = status;
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            displayOrders();
        }

        // æ¥å•
        async function acceptOrder(orderId) {
            try {
                const response = await fetch(`${API_BASE}/api/merchant/orders/${orderId}/accept`, {
                    method: 'POST'
                });

                if (response.ok) {
                    showNotification('âœ… è®¢å•å·²æ¥å—');
                    await loadOrders();
                } else {
                    alert('æ¥å•å¤±è´¥ï¼Œè¯·é‡è¯•');
                }
            } catch (error) {
                console.error('æ¥å•å¤±è´¥:', error);
                alert('æ¥å•å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
            }
        }

        // å¼€å§‹åˆ¶ä½œ
        async function startPreparing(orderId) {
            try {
                const response = await fetch(`${API_BASE}/api/merchant/orders/${orderId}/start`, {
                    method: 'POST'
                });

                if (response.ok) {
                    showNotification('ğŸ³ å¼€å§‹åˆ¶ä½œè®¢å•');
                    await loadOrders();
                } else {
                    alert('æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•');
                }
            } catch (error) {
                console.error('æ“ä½œå¤±è´¥:', error);
                alert('æ“ä½œå¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
            }
        }

        // å®Œæˆè®¢å•
        async function completeOrder(orderId) {
            try {
                const response = await fetch(`${API_BASE}/api/merchant/orders/${orderId}/complete`, {
                    method: 'POST'
                });

                if (response.ok) {
                    showNotification('âœ… è®¢å•å·²å®Œæˆ');
                    await loadOrders();
                } else {
                    alert('æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•');
                }
            } catch (error) {
                console.error('æ“ä½œå¤±è´¥:', error);
                alert('æ“ä½œå¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
            }
        }

        // å–æ¶ˆè®¢å•
        async function cancelOrder(orderId) {
            if (!confirm('ç¡®å®šè¦æ‹’ç»è¿™ä¸ªè®¢å•å—ï¼Ÿ')) return;
            
            try {
                const response = await fetch(`${API_BASE}/api/merchant/orders/${orderId}/cancel`, {
                    method: 'POST'
                });

                if (response.ok) {
                    showNotification('âŒ è®¢å•å·²å–æ¶ˆ');
                    await loadOrders();
                } else {
                    alert('æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•');
                }
            } catch (error) {
                console.error('æ“ä½œå¤±è´¥:', error);
                alert('æ“ä½œå¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
            }
        }

        // æŸ¥çœ‹è®¢å•è¯¦æƒ…ï¼ˆåŒ…å«åˆ¶ä½œè¯´æ˜ï¼‰
        async function viewOrderDetail(orderId) {
            try {
                const response = await fetch(`${API_BASE}/api/merchant/orders/${orderId}`);
                const order = await response.json();

                const statusText = {
                    'pending': 'å¾…æ¥å•',
                    'accepted': 'å·²æ¥å•',
                    'preparing': 'åˆ¶ä½œä¸­',
                    'completed': 'å·²å®Œæˆ',
                    'cancelled': 'å·²å–æ¶ˆ'
                }[order.status] || order.status;

                const itemsHtml = order.items.map((item, index) => `
                    <div style="border: 1px solid #eee; border-radius: 10px; padding: 15px; margin-bottom: 15px; background: #f9f9f9;">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                            <div>
                                <div style="font-size: 18px; font-weight: bold; color: #333;">${item.dish_name}</div>
                                <div style="color: #666; margin-top: 5px;">æ•°é‡: <span style="color: #ff6b6b; font-weight: bold;">x${item.quantity}</span> | å•ä»·: Â¥${item.price}</div>
                            </div>
                            <div style="font-size: 18px; font-weight: bold; color: #ff6b6b;">Â¥${(item.price * item.quantity).toFixed(2)}</div>
                        </div>
                        ${item.description ? `<div style="color: #888; font-size: 14px; margin-bottom: 10px;">ğŸ“ ${item.description}</div>` : ''}
                        ${item.cooking_instructions ? `
                            <details style="margin-top: 10px;">
                                <summary style="cursor: pointer; color: #667eea; font-weight: bold; padding: 10px; background: white; border-radius: 8px;">ğŸ‘¨â€ğŸ³ åˆ¶ä½œè¯´æ˜ï¼ˆç‚¹å‡»æŸ¥çœ‹ï¼‰</summary>
                                <div style="background: white; padding: 15px; border-radius: 8px; margin-top: 8px; white-space: pre-wrap; font-size: 14px; line-height: 1.6; border-left: 4px solid #667eea;">${item.cooking_instructions}</div>
                            </details>
                        ` : '<div style="color: #999; font-size: 13px; padding: 10px; background: white; border-radius: 8px; text-align: center;">æš‚æ— åˆ¶ä½œè¯´æ˜</div>'}
                    </div>
                `).join('');

                document.getElementById('orderDetailContent').innerHTML = `
                    <div style="margin-bottom: 20px;">
                        <div style="font-size: 16px; margin-bottom: 10px;"><strong>è®¢å•å·ï¼š</strong>${order.id}</div>
                        <div style="font-size: 14px; margin-bottom: 10px;"><strong>é¡¾å®¢ï¼š</strong>${order.user_name}</div>
                        <div style="font-size: 14px; margin-bottom: 10px;"><strong>ä¸‹å•æ—¶é—´ï¼š</strong>${new Date(order.created_at).toLocaleString('zh-CN')}</div>
                        <div style="font-size: 14px; margin-bottom: 10px;">
                            <strong>è®¢å•çŠ¶æ€ï¼š</strong>
                            <span style="padding: 5px 15px; background: ${order.status === 'pending' ? '#fff3cd' : order.status === 'accepted' ? '#d1ecf1' : order.status === 'preparing' ? '#d4edda' : '#e2e3e5'}; border-radius: 15px; font-weight: bold;">${statusText}</span>
                        </div>
                        ${order.note ? `<div style="background: #fffbea; padding: 12px; border-radius: 8px; margin-top: 10px; border-left: 4px solid #ffc107;"><strong>ğŸ“ å¤‡æ³¨ï¼š</strong>${order.note}</div>` : ''}
                    </div>
                    
                    <div style="border-top: 2px dashed #eee; padding-top: 15px; margin-bottom: 15px;">
                        <h3 style="margin-bottom: 15px;">ğŸ“‹ è®¢å•æ˜ç»†</h3>
                        ${itemsHtml}
                    </div>
                    
                    <div style="border-top: 2px dashed #eee; padding-top: 15px;">
                        <div style="font-size: 24px; font-weight: bold; color: #ff6b6b; text-align: right;">
                            åˆè®¡ï¼šÂ¥${order.total_amount.toFixed(2)}
                        </div>
                    </div>
                `;

                document.getElementById('orderDetailModal').style.display = 'flex';
            } catch (error) {
                console.error('åŠ è½½è®¢å•è¯¦æƒ…å¤±è´¥:', error);
                alert('åŠ è½½å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }

        // å…³é—­è®¢å•è¯¦æƒ…æ¨¡æ€æ¡†
        function closeOrderDetailModal() {
            document.getElementById('orderDetailModal').style.display = 'none';
        }

        // æ›´æ–°è®¢å•çŠ¶æ€ï¼ˆä¿ç•™æ—§æ–¹æ³•ä»¥å…¼å®¹ï¼‰
        async function updateOrderStatus(orderId, newStatus) {
            try {
                const response = await fetch(`${API_BASE}/api/merchant/orders/${orderId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ status: newStatus })
                });

                if (response.ok) {
                    showNotification(`è®¢å•çŠ¶æ€å·²æ›´æ–°ä¸º: ${newStatus}`);
                    await loadOrders();
                }
            } catch (error) {
                console.error('æ›´æ–°è®¢å•çŠ¶æ€å¤±è´¥:', error);
                alert('æ›´æ–°å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }

        // æ˜¾ç¤ºé€šçŸ¥
        function showNotification(message) {
            const notif = document.getElementById('notification');
            notif.textContent = message;
            notif.classList.add('show');
            setTimeout(() => {
                notif.classList.remove('show');
            }, 3000);
        }

        // WebSocketè¿æ¥
        function connectWebSocket() {
            ws = new WebSocket(WS_URL);

            ws.onopen = () => {
                console.log('WebSocketè¿æ¥æˆåŠŸ');
                const status = document.getElementById('connectionStatus');
                status.className = 'connection-status status-connected';
                status.textContent = 'ğŸŸ¢ å·²è¿æ¥';
            };

            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                console.log('æ”¶åˆ°æ–°è®¢å•:', data);
                showNotification('ğŸ”” æ–°è®¢å•åˆ°è¾¾ï¼');
                
                // æ’­æ”¾æç¤ºéŸ³ï¼ˆå¯é€‰ï¼‰
                const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBze/ejDcIF2S56+2iUw0PVand8bhnGwU7k9r0x3QpBS19zvDahzgIGGi78OGcTwwOUKXh8bllHAU7k9r0x3QpBS19zvDahzgIGGi78OGcTwwOUKXh8bllHAU7k9r0x3QpBS19zvDahzgIGGi78OGcTwwOUKXh8bllHAU7k9r0x3QpBS19zvDahzgIGGi78OGcTwwOUKXh8bllHAU7k9r0x3QpBS19zvDahzgIGGi78OGcTwwOUKXh8bllHAU7k9r0x3QpBS19zvDahzgIGGi78OGcTwwOUKXh8bllHAU7k9r0x3QpBS19zvDahzgIGGi78OGcTwwO');
                // audio.play();

                loadOrders();
            };

            ws.onclose = () => {
                console.log('WebSocketè¿æ¥å…³é—­');
                const status = document.getElementById('connectionStatus');
                status.className = 'connection-status status-disconnected';
                status.textContent = 'ğŸ”´ æœªè¿æ¥';
                
                // 5ç§’åé‡è¿
                setTimeout(connectWebSocket, 5000);
            };

            ws.onerror = (error) => {
                console.error('WebSocketé”™è¯¯:', error);
            };
        }

        // æ˜¾ç¤ºæ·»åŠ èœå“æ¨¡æ€æ¡†
        function showAddDishModal() {
            document.getElementById('addDishModal').style.display = 'flex';
            document.getElementById('addDishForm').reset();
        }

        // å…³é—­æ·»åŠ èœå“æ¨¡æ€æ¡†
        function closeAddDishModal() {
            document.getElementById('addDishModal').style.display = 'none';
        }

        // æäº¤æ–°èœå“
        async function submitNewDish(event) {
            event.preventDefault();
            
            const dishData = {
                id: Date.now(), // ä½¿ç”¨æ—¶é—´æˆ³ä½œä¸ºä¸´æ—¶ID
                name: document.getElementById('dishName').value,
                category: 'èœå“', // ç»Ÿä¸€åˆ†ç±»
                price: parseFloat(document.getElementById('dishPrice').value),
                description: document.getElementById('dishDescription').value,
                cooking_instructions: document.getElementById('dishInstructions').value || 'æš‚æ— åˆ¶ä½œè¯´æ˜',
                is_available: document.getElementById('dishAvailable').checked,
                image_url: null
            };

            try {
                const response = await fetch(`${API_BASE}/api/merchant/dishes`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(dishData)
                });

                if (response.ok) {
                    showNotification('âœ… èœå“æ·»åŠ æˆåŠŸï¼');
                    closeAddDishModal();
                    // å¯é€‰ï¼šåˆ·æ–°èœå“åˆ—è¡¨
                } else {
                    alert('æ·»åŠ å¤±è´¥ï¼Œè¯·é‡è¯•');
                }
            } catch (error) {
                console.error('æ·»åŠ èœå“å¤±è´¥:', error);
                alert('æ·»åŠ å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
            }
        }

        // æŸ¥çœ‹èœå“åˆ—è¡¨
        async function viewDishes() {
            try {
                const response = await fetch(`${API_BASE}/api/user/dishes`);
                const dishes = await response.json();
                
                const container = document.getElementById('dishListContent');
                if (dishes.length === 0) {
                    container.innerHTML = '<div style="text-align: center; padding: 40px; color: #999;">æš‚æ— èœå“</div>';
                } else {
                    container.innerHTML = dishes.map(dish => `
                        <div style="border: 1px solid #eee; border-radius: 10px; padding: 15px; margin-bottom: 15px;">
                            <div style="display: flex; justify-content: space-between; align-items: start;">
                                <div style="flex: 1;">
                                    <div style="font-size: 18px; font-weight: bold; margin-bottom: 5px;">${dish.name}</div>
                                    <div style="color: #666; font-size: 14px; margin-bottom: 5px;">${dish.description}</div>
                                    <div style="color: #ff6b6b; font-size: 20px; font-weight: bold; margin-top: 10px;">Â¥${dish.price.toFixed(2)}</div>
                                </div>
                                <div style="text-align: right;">
                                    <div style="padding: 5px 12px; background: ${dish.is_available ? '#4CAF50' : '#999'}; color: white; border-radius: 15px; font-size: 12px; margin-bottom: 10px;">
                                        ${dish.is_available ? 'âœ… åœ¨å”®' : 'âŒ ä¸‹æ¶'}
                                    </div>
                                    <button onclick="editDish(${dish.id})" style="padding: 8px 16px; background: #667eea; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: bold;">âœï¸ ç¼–è¾‘</button>
                                </div>
                            </div>
                            ${dish.cooking_instructions && dish.cooking_instructions !== 'æš‚æ— åˆ¶ä½œè¯´æ˜' ? `
                                <details style="margin-top: 10px;">
                                    <summary style="cursor: pointer; color: #667eea; font-weight: bold;">ğŸ“– åˆ¶ä½œè¯´æ˜</summary>
                                    <div style="background: #f5f5f5; padding: 10px; border-radius: 8px; margin-top: 5px; white-space: pre-wrap; font-size: 13px;">${dish.cooking_instructions}</div>
                                </details>
                            ` : ''}
                        </div>
                    `).join('');
                }
                
                document.getElementById('dishListModal').style.display = 'flex';
            } catch (error) {
                console.error('åŠ è½½èœå“å¤±è´¥:', error);
                alert('åŠ è½½å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }

        // å…³é—­èœå“åˆ—è¡¨æ¨¡æ€æ¡†
        function closeDishListModal() {
            document.getElementById('dishListModal').style.display = 'none';
        }

        // ç¼–è¾‘èœå“
        async function editDish(dishId) {
            try {
                const response = await fetch(`${API_BASE}/api/user/dishes`);
                const dishes = await response.json();
                const dish = dishes.find(d => d.id === dishId);
                
                if (dish) {
                    document.getElementById('editDishId').value = dish.id;
                    document.getElementById('editDishName').value = dish.name;
                    document.getElementById('editDishPrice').value = dish.price;
                    document.getElementById('editDishDescription').value = dish.description;
                    document.getElementById('editDishInstructions').value = dish.cooking_instructions === 'æš‚æ— åˆ¶ä½œè¯´æ˜' ? '' : dish.cooking_instructions;
                    document.getElementById('editDishAvailable').checked = dish.is_available;
                    
                    // å…³é—­èœå“åˆ—è¡¨æ¨¡æ€æ¡†
                    closeDishListModal();
                    // æ‰“å¼€ç¼–è¾‘æ¨¡æ€æ¡†
                    document.getElementById('editDishModal').style.display = 'flex';
                }
            } catch (error) {
                console.error('åŠ è½½èœå“è¯¦æƒ…å¤±è´¥:', error);
                alert('åŠ è½½å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }

        // å…³é—­ç¼–è¾‘èœå“æ¨¡æ€æ¡†
        function closeEditDishModal() {
            document.getElementById('editDishModal').style.display = 'none';
        }

        // æäº¤ç¼–è¾‘èœå“
        async function submitEditDish(event) {
            event.preventDefault();
            
            const dishId = parseInt(document.getElementById('editDishId').value);
            const dishData = {
                id: dishId,
                name: document.getElementById('editDishName').value,
                category: 'èœå“', // ç»Ÿä¸€åˆ†ç±»
                price: parseFloat(document.getElementById('editDishPrice').value),
                description: document.getElementById('editDishDescription').value,
                cooking_instructions: document.getElementById('editDishInstructions').value || 'æš‚æ— åˆ¶ä½œè¯´æ˜',
                is_available: document.getElementById('editDishAvailable').checked,
                image_url: null
            };

            try {
                const response = await fetch(`${API_BASE}/api/merchant/dishes/${dishId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(dishData)
                });

                if (response.ok) {
                    showNotification('âœ… èœå“ä¿®æ”¹æˆåŠŸï¼');
                    closeEditDishModal();
                    // åˆ·æ–°èœå“åˆ—è¡¨
                    viewDishes();
                } else {
                    alert('ä¿®æ”¹å¤±è´¥ï¼Œè¯·é‡è¯•');
                }
            } catch (error) {
                console.error('ä¿®æ”¹èœå“å¤±è´¥:', error);
                alert('ä¿®æ”¹å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
            }
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        loadOrders();
        connectWebSocket();

        // å®šæœŸåˆ·æ–°è®¢å•ï¼ˆä½œä¸ºWebSocketçš„å¤‡ç”¨æ–¹æ¡ˆï¼‰
        setInterval(loadOrders, 30000);
    </script>
</body>
</html>