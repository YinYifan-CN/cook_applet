# 微信小程序上架完整指南

## 📋 目录
1. [前期准备](#前期准备)
2. [后端改造](#后端改造)
3. [小程序端开发](#小程序端开发)
4. [部署上线](#部署上线)
5. [提交审核](#提交审核)

---

## 一、前期准备

### 1.1 注册微信小程序
1. 访问 [微信公众平台](https://mp.weixin.qq.com/)
2. 注册小程序账号（个人或企业）
3. 完成主体信息认证
4. 获取 **AppID**（开发->开发管理->开发设置）

### 1.2 准备服务器
- **域名**：需要已备案的域名
- **SSL证书**：必须支持HTTPS
- **服务器**：推荐使用云服务器（阿里云/腾讯云/华为云）

### 1.3 下载开发工具
- [微信开发者工具](https://developers.weixin.qq.com/miniprogram/dev/devtools/download.html)

---

## 二、后端改造

### 2.1 当前项目问题
❌ **localhost** - 微信小程序无法访问本地服务器  
❌ **HTTP** - 微信小程序要求HTTPS  
❌ **SQLite** - 服务器重启数据会丢失（需改为持久化数据库）  
❌ **WebSocket (ws://)** - 需要改为加密的wss://

### 2.2 必需修改项

#### 2.2.1 数据库改造（可选但推荐）
```python
# 当前：SQLite（本地文件）
# 建议改为：MySQL 或 PostgreSQL

# 示例：MySQL配置
DATABASE_URL = "mysql+pymysql://user:password@host:3306/cook_db"
```

#### 2.2.2 部署到云服务器
后端需要部署到有公网IP的服务器，推荐方案：

**方案A：腾讯云/阿里云服务器**
```bash
# 1. 购买云服务器（最低配即可）
# 2. 配置域名解析（A记录指向服务器IP）
# 3. 申请SSL证书（免费）
# 4. 使用Nginx反向代理
# 5. 配置HTTPS

# Nginx配置示例
server {
    listen 443 ssl;
    server_name api.yourdomain.com;
    
    ssl_certificate /path/to/cert.pem;
    ssl_certificate_key /path/to/key.pem;
    
    location / {
        proxy_pass http://127.0.0.1:8000;
        proxy_set_header Host $host;
    }
    
    # WebSocket支持
    location /ws/ {
        proxy_pass http://127.0.0.1:8000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }
}
```

**方案B：Railway/Render（简单快速）**
- 支持自动HTTPS
- 从GitHub部署
- 免费套餐可用
- 但WebSocket在免费套餐可能受限

#### 2.2.3 修改CORS配置
```python
# Cook_applet.py
app.add_middleware(
    CORSMiddleware,
    allow_origins=[
        "https://servicewechat.com",  # 微信小程序域名
        "https://yourdomain.com"      # 你的域名
    ],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)
```

### 2.3 微信公众平台配置
部署后端后，在微信公众平台配置：
1. **开发管理** -> **开发设置** -> **服务器域名**
2. 配置以下域名（都需要HTTPS）：
   - **request合法域名**：`https://api.yourdomain.com`
   - **socket合法域名**：`wss://api.yourdomain.com`（如使用WebSocket）
   - **uploadFile合法域名**：`https://api.yourdomain.com`
   - **downloadFile合法域名**：`https://api.yourdomain.com`

---

## 三、小程序端开发

### 3.1 创建小程序项目结构
```
miniprogram/
├── pages/
│   ├── index/          # 菜品列表页
│   ├── cart/           # 购物车页
│   ├── order/          # 订单列表页
│   └── merchant/       # 商家管理页（可选）
├── utils/
│   └── api.js          # API封装
├── app.js              # 小程序入口
├── app.json            # 全局配置
└── app.wxss            # 全局样式
```

### 3.2 核心代码改造

#### 3.2.1 API配置 (utils/api.js)
```javascript
const API_BASE = 'https://api.yourdomain.com'  // 替换为你的域名

// 封装请求
function request(url, options = {}) {
  return new Promise((resolve, reject) => {
    wx.request({
      url: API_BASE + url,
      method: options.method || 'GET',
      data: options.data || {},
      header: {
        'content-type': 'application/json',
      },
      success: (res) => {
        if (res.statusCode === 200) {
          resolve(res.data)
        } else {
          reject(res)
        }
      },
      fail: reject
    })
  })
}

// API方法
module.exports = {
  // 获取菜品列表
  getDishes: () => request('/api/user/dishes'),
  
  // 创建订单
  createOrder: (data) => request('/api/user/orders', {
    method: 'POST',
    data: data
  }),
  
  // 获取订单列表
  getOrders: (userId) => request(`/api/user/orders/${userId}`)
}
```

#### 3.2.2 菜品列表页 (pages/index/index.js)
```javascript
const api = require('../../utils/api.js')

Page({
  data: {
    dishes: [],
    cart: []
  },
  
  onLoad() {
    this.loadDishes()
  },
  
  // 加载菜品
  async loadDishes() {
    wx.showLoading({ title: '加载中' })
    try {
      const dishes = await api.getDishes()
      this.setData({ dishes })
    } catch (err) {
      wx.showToast({ title: '加载失败', icon: 'none' })
    }
    wx.hideLoading()
  },
  
  // 添加到购物车
  addToCart(e) {
    const dish = e.currentTarget.dataset.dish
    // 购物车逻辑...
  }
})
```

#### 3.2.3 WebSocket改造
```javascript
// 当前：ws://localhost:8000/ws/merchant
// 改为：wss://api.yourdomain.com/ws/merchant

const socket = wx.connectSocket({
  url: 'wss://api.yourdomain.com/ws/merchant'
})

socket.onOpen(() => {
  console.log('WebSocket连接成功')
})

socket.onMessage((res) => {
  const data = JSON.parse(res.data)
  // 处理新订单通知
})
```

### 3.3 微信登录集成
```javascript
// app.js
App({
  onLaunch() {
    // 检查登录状态
    wx.login({
      success: (res) => {
        // 发送code到后端换取session
        wx.request({
          url: 'https://api.yourdomain.com/api/user/login',
          method: 'POST',
          data: { code: res.code },
          success: (res) => {
            // 保存token
            wx.setStorageSync('token', res.data.token)
          }
        })
      }
    })
  }
})
```

### 3.4 后端添加微信登录接口
```python
# Cook_applet.py

import requests

@app.post("/api/user/login")
async def wechat_login(code: str):
    """微信登录"""
    # 微信小程序配置
    APPID = "你的小程序AppID"
    SECRET = "你的小程序AppSecret"
    
    # 调用微信接口获取openid
    url = f"https://api.weixin.qq.com/sns/jscode2session"
    params = {
        "appid": APPID,
        "secret": SECRET,
        "js_code": code,
        "grant_type": "authorization_code"
    }
    
    response = requests.get(url, params=params)
    data = response.json()
    
    if "openid" in data:
        openid = data["openid"]
        # 生成token，保存用户信息等
        return {"token": "生成的token", "openid": openid}
    else:
        raise HTTPException(status_code=400, detail="登录失败")
```

---

## 四、部署上线

### 4.1 后端部署步骤
```bash
# 1. 连接到云服务器
ssh root@your-server-ip

# 2. 安装依赖
apt update
apt install python3-pip nginx certbot

# 3. 上传代码
# 使用git clone或scp上传

# 4. 安装Python依赖
cd /var/www/cook_applet
pip3 install -r requirements.txt

# 5. 配置systemd服务（开机自启）
nano /etc/systemd/system/cook_applet.service

# 内容：
[Unit]
Description=Cook Applet API
After=network.target

[Service]
User=www-data
WorkingDirectory=/var/www/cook_applet
Environment="PATH=/usr/bin"
ExecStart=/usr/bin/python3 /var/www/cook_applet/Cook_applet.py

[Install]
WantedBy=multi-user.target

# 6. 启动服务
systemctl enable cook_applet
systemctl start cook_applet

# 7. 申请SSL证书
certbot --nginx -d api.yourdomain.com

# 8. 配置Nginx（参考前面的配置）
```

### 4.2 小程序端构建
1. 使用微信开发者工具打开小程序项目
2. 填入AppID
3. 点击"上传"，填写版本号和备注
4. 上传成功后，代码会进入"开发版本"

---

## 五、提交审核

### 5.1 设置体验版
1. 登录[微信公众平台](https://mp.weixin.qq.com/)
2. **版本管理** -> 选择开发版本 -> 设为体验版
3. 添加体验成员进行测试

### 5.2 提交审核
1. 确认体验版功能正常
2. **版本管理** -> 选择开发版本 -> **提交审核**
3. 填写审核信息：
   - 功能页面截图
   - 功能说明
   - 测试账号（如需要）
4. 等待审核（通常1-7天）

### 5.3 发布上线
审核通过后，在版本管理中点击"发布"即可上线

---

## 六、快速方案（简化版）

如果想快速体验，可以使用以下简化方案：

### 方案：使用内网穿透（仅测试用）
```bash
# 使用ngrok或frp等工具将本地服务暴露到公网
# 注意：仅用于开发测试，不能用于正式上线

# 1. 安装ngrok
# 2. 启动服务
python Cook_applet.py

# 3. 开启穿透
ngrok http 8000

# 4. 获得临时域名（如 https://abc123.ngrok.io）
# 5. 在微信开发者工具中配置此域名
```

**⚠️ 注意**：
- 内网穿透只能用于开发测试
- 正式上线必须使用自己的域名和服务器
- 微信审核时会检查域名合法性

---

## 七、常见问题

### Q1: 个人主体可以注册小程序吗？
✅ 可以，但功能受限（如无法开通支付）

### Q2: 必须要企业认证吗？
如果需要支付功能，必须企业认证（300元/年）

### Q3: 服务器最低配置？
1核2G即可，流量小可用学生机

### Q4: 域名必须备案吗？
✅ 是的，微信小程序要求服务器域名必须在中国大陆备案

### Q5: 可以用免费服务器吗？
可以，但稳定性无保障，正式上线建议购买云服务器

---

## 八、成本估算

| 项目 | 费用 | 说明 |
|------|------|------|
| 小程序注册 | 300元/年 | 企业认证（个人免费但功能受限） |
| 域名 | 50-100元/年 | .com/.cn域名 |
| 服务器 | 100-500元/年 | 学生机或轻量服务器 |
| SSL证书 | 免费 | Let's Encrypt免费证书 |
| **总计** | **450-900元/年** | 个人开发可更低 |

---

## 九、推荐学习资源

- [微信小程序官方文档](https://developers.weixin.qq.com/miniprogram/dev/framework/)
- [云开发QuickStart](https://developers.weixin.qq.com/miniprogram/dev/wxcloud/basis/getting-started.html)
- [FastAPI部署文档](https://fastapi.tiangolo.com/deployment/)

---

**需要我帮你开始小程序端代码的开发吗？**
