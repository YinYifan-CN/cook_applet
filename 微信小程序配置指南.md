# 微信小程序配置指南

## 🎯 问题说明
微信小程序运行在手机上，无法访问 `localhost`，需要使用可访问的网络地址。

## ✅ 当前配置状态
已将API地址更新为：**http://192.168.70.209:8000**

---

## 📱 使用步骤

### 1️⃣ 确保后端服务正在运行
后端服务已启动，运行在 `http://0.0.0.0:8000`（监听所有网络接口）

### 2️⃣ 手机连接WiFi
**重要：手机必须和电脑连接同一个WiFi网络！**

### 3️⃣ 在微信开发者工具中配置

#### 步骤1：打开项目
- 打开微信开发者工具
- 选择 `d:\MyCode\cook_applet\miniprogram` 目录导入项目
- AppID：如果没有可以使用测试号

#### 步骤2：关闭域名校验（开发阶段）
在微信开发者工具中：
1. 点击右上角"详情"
2. 找到"本地设置"
3. 勾选 ✅ **不校验合法域名、web-view（业务域名）、TLS 版本以及 HTTPS 证书**

#### 步骤3：编译运行
1. 点击"编译"按钮
2. 在模拟器中测试
3. 点击"预览"生成二维码
4. 用手机微信扫码真机测试

---

## 🔧 配置文件说明

### 文件1：`miniprogram/utils/api.js`
```javascript
const USE_LOCAL = false  // 改为false使用局域网IP
const API_BASE = 'http://192.168.70.209:8000'
```

### 文件2：`miniprogram/app.js`
```javascript
globalData: {
  apiBase: 'http://192.168.70.209:8000'
}
```

---

## 🚨 常见问题

### Q1: 小程序显示"请求失败"或"网络错误"
**解决方案：**
1. ✅ 确认手机和电脑在同一WiFi
2. ✅ 确认后端服务正在运行
3. ✅ 在微信开发者工具中关闭域名校验
4. ✅ 检查电脑防火墙是否允许8000端口

### Q2: 如何测试API是否可访问？
在手机浏览器中访问：
```
http://192.168.70.209:8000/api/user/dishes
```
如果能看到JSON数据，说明API可访问。

### Q3: 换了WiFi或电脑IP变了怎么办？
重新获取IP并更新配置：
```powershell
# 查看当前IP
ipconfig | Select-String "192.168"

# 更新 miniprogram/utils/api.js 中的 API_BASE
# 更新 miniprogram/app.js 中的 apiBase
```

### Q4: 防火墙阻止了端口怎么办？
临时关闭防火墙或添加规则：
```powershell
# 允许8000端口入站
New-NetFirewallRule -DisplayName "Allow Port 8000" -Direction Inbound -LocalPort 8000 -Protocol TCP -Action Allow
```

---

## 🌐 进阶：使用 ngrok 内网穿透（可选）

如果手机和电脑不在同一WiFi（如需远程测试），可以使用ngrok：

### 1. 安装 ngrok
访问 https://ngrok.com/download 下载安装

### 2. 启动 ngrok
```powershell
ngrok http 8000
```

### 3. 获取公网URL
ngrok会提供一个URL，例如：`https://xxxx-xxx-xxx-xxx.ngrok-free.app`

### 4. 更新小程序配置
将 `API_BASE` 改为 ngrok 提供的URL（注意是https）

### 5. ngrok 注意事项
- 免费版URL每次启动都会变化
- 有请求限制
- 可能需要注册账号获取authtoken

---

## 📦 生产环境部署

正式上线时需要：

### 1. 部署后端到服务器
- 购买云服务器（阿里云、腾讯云等）
- 部署FastAPI后端
- 配置nginx反向代理
- 申请SSL证书（https）

### 2. 配置微信小程序合法域名
- 登录微信公众平台
- 开发 → 开发管理 → 开发设置 → 服务器域名
- 添加你的域名（必须https）

### 3. 更新小程序配置
```javascript
const API_BASE = 'https://api.yourdomain.com'
```

---

## 🎯 快速检查清单

开发测试前，请确认：
- [ ] 后端服务正在运行（http://192.168.70.209:8000）
- [ ] 手机和电脑连接同一WiFi
- [ ] 微信开发者工具已关闭域名校验
- [ ] 防火墙允许8000端口
- [ ] 小程序配置文件中的IP地址正确

---

## 💡 提示

### 当前配置适用于：
- ✅ 开发调试
- ✅ 局域网测试
- ✅ 真机预览

### 不适用于：
- ❌ 正式发布
- ❌ 远程访问（不同网络）
- ❌ 提交审核

**正式发布前必须部署到有https域名的服务器！**
