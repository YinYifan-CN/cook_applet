<!--pages/merchant/merchant.wxml-->
<wxs module="utils">
  var toFixed = function(num, digits) {
    return Number(num).toFixed(digits || 2);
  };
  module.exports.toFixed = toFixed;
</wxs>

<view class="container">
  <!-- Tabåˆ‡æ¢ -->
  <view class="tab-bar">
    <view 
      class="tab-item {{currentTab === 'orders' ? 'active' : ''}}" 
      bindtap="switchTab" 
      data-tab="orders"
    >è®¢å•ç®¡ç†</view>
    <view 
      class="tab-item {{currentTab === 'dishes' ? 'active' : ''}}" 
      bindtap="switchTab" 
      data-tab="dishes"
    >èœå“ç®¡ç†</view>
  </view>

  <!-- è®¢å•ç®¡ç† -->
  <view wx:if="{{currentTab === 'orders'}}">
    <!-- ç»Ÿè®¡å¡ç‰‡ -->
  <view class="stats-section">
    <view class="stat-card">
      <view class="stat-value">{{totalOrders}}</view>
      <view class="stat-label">æ€»è®¢å•</view>
    </view>
    <view class="stat-card pending">
      <view class="stat-value">{{pendingOrders}}</view>
      <view class="stat-label">å¾…å¤„ç†</view>
    </view>
  </view>

  <!-- ç­›é€‰æ  -->
  <view class="filter-bar">
    <view 
      class="filter-item {{statusFilter === 'all' ? 'active' : ''}}" 
      bindtap="filterOrders" 
      data-status="all"
    >å…¨éƒ¨</view>
    <view 
      class="filter-item {{statusFilter === 'pending' ? 'active' : ''}}" 
      bindtap="filterOrders" 
      data-status="pending"
    >å¾…ç¡®è®¤</view>
    <view 
      class="filter-item {{statusFilter === 'preparing' ? 'active' : ''}}" 
      bindtap="filterOrders" 
      data-status="preparing"
    >åˆ¶ä½œä¸­</view>
    <view 
      class="filter-item {{statusFilter === 'completed' ? 'active' : ''}}" 
      bindtap="filterOrders" 
      data-status="completed"
    >å·²å®Œæˆ</view>
  </view>

  <!-- è®¢å•åˆ—è¡¨ -->
  <view class="order-list">
    <view class="order-card" wx:for="{{filteredOrders}}" wx:key="id">
      <view class="order-header" bindtap="viewOrderDetail" data-order="{{item}}">
        <view class="order-info">
          <view class="order-id">{{item.id}}</view>
          <view class="order-user">é¡¾å®¢ï¼š{{item.user_name}}</view>
        </view>
        <view class="order-status status-{{item.status}}">{{statusMap[item.status]}}</view>
      </view>

      <view class="order-items">
        <view class="order-item" wx:for="{{item.items}}" wx:key="dish_id" wx:for-item="dish">
          <text>{{dish.dish_name}} x{{dish.quantity}}</text>
          <text class="item-price">Â¥{{utils.toFixed(dish.price * dish.quantity, 2)}}</text>
        </view>
      </view>

      <view class="order-footer">
        <view class="order-time">{{formatTime(item.created_at)}}</view>
        <view class="order-total">Â¥{{item.total_amount}}</view>
      </view>

      <!-- æ“ä½œæŒ‰é’® -->
      <view class="order-actions" wx:if="{{item.nextStatus}}">
        <button 
          class="btn-action"
          bindtap="updateStatus"
          data-order-id="{{item.id}}"
          data-status="{{item.nextStatus}}"
        >
          {{item.nextStatusText}}
        </button>
      </view>
    </view>
  </view>

  <!-- ç©ºçŠ¶æ€ -->
  <view class="empty-state" wx:if="{{filteredOrders.length === 0}}">
    <view class="empty-state-icon">ğŸ“‹</view>
    <view class="empty-state-text">æš‚æ— è®¢å•</view>
  </view>
  </view>

  <!-- èœå“ç®¡ç† -->
  <view wx:if="{{currentTab === 'dishes'}}">
    <view class="dish-header">
      <button class="btn-add-dish" bindtap="showAddDishDialog">+ æ·»åŠ èœå“</button>
    </view>

    <view class="dish-list">
      <view class="dish-card" wx:for="{{dishes}}" wx:key="id">
        <view class="dish-info">
          <view class="dish-name">{{item.name}}</view>
          <view class="dish-price">Â¥{{item.price}}</view>
          <view class="dish-desc">{{item.description}}</view>
        </view>
        <view class="dish-actions">
          <button class="btn-edit" bindtap="editDish" data-dish="{{item}}">ç¼–è¾‘</button>
          <button class="btn-delete" bindtap="deleteDish" data-id="{{item.id}}">åˆ é™¤</button>
        </view>
      </view>
    </view>

    <view class="empty-state" wx:if="{{dishes.length === 0}}">
      <view class="empty-state-icon">ğŸ½ï¸</view>
      <view class="empty-state-text">æš‚æ— èœå“</view>
    </view>
  </view>
</view>
